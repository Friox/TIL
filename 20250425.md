# 2025. 04. 25.

## ğŸ€ ì¸ì¦ê´€ë ¨ í•„í„°ê°€ ë‘ë²ˆ ì‘ë™í•¨
### í˜„ìƒ
```
2025-04-25T10:04:34.775+09:00  INFO 5311 --- [backend] [nio-8080-exec-2] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2025-04-25T10:04:34.775+09:00  INFO 5311 --- [backend] [nio-8080-exec-2] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2025-04-25T10:04:34.777+09:00  INFO 5311 --- [backend] [nio-8080-exec-2] o.s.web.servlet.DispatcherServlet        : Completed initialization in 2 ms
2025-04-25T10:04:34.778+09:00 ERROR 5311 --- [backend] [nio-8080-exec-2] d.f.d.b.security.jwt.JwtTokenProvider    : ìœ íš¨í•˜ì§€ ì•Šì€ JWT ì„œëª…
2025-04-25T10:04:34.779+09:00 ERROR 5311 --- [backend] [nio-8080-exec-2] d.f.d.b.security.jwt.JwtTokenProvider    : ìœ íš¨í•˜ì§€ ì•Šì€ JWT ì„œëª…
```
JWT ì¸ì¦í•„í„°ë¥¼ í…ŒìŠ¤íŠ¸í•˜ë˜ ì¤‘, Filterì—ì„œ JwtTokenProviderë¥¼ í˜¸ì¶œí•˜ì—¬ í† í°ì„ ê²€ì¦í•˜ëŠ”ë°  
í† í° ê²€ì¦ í•¨ìˆ˜ê°€ ë‘ë²ˆ ì‹¤í–‰ë˜ëŠ”ê²ƒì„ ë°œê²¬í–ˆë‹¤.  

### ì›ì¸
ë¨¼ì € ë‘ ë²ˆ ì‹¤í–‰ë˜ëŠ” ì´ìœ ëŠ”, ì¸ì¦ì´ í•„ìš”í•œ ì—”ë“œí¬ì¸íŠ¸ì— ì¸ì¦ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ì±„ë¡œ ì ‘ê·¼í•˜ì—¬  
ì¸ì¦ ì˜ˆì™¸ê°€ ë°œìƒí•˜ì˜€ê³ , ë•Œë¬¸ì— `/error` í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŒ…ë˜ëŠ”ë°  
ì´ ë§ˆì €ë„ ì¸ì¦ì´ í•„ìš”í•œ ì—”ë“œí¬ì¸íŠ¸ë¼ í•œë²ˆ ë” ì„œëª…ì„ ê²€ì¦í•˜ê²Œë˜ì–´ ë‘ ë²ˆ ë°œìƒí•œ ê²ƒ.

### í•´ê²°ê³¼ì •
```java
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends GenericFilterBean {

    private final JwtTokenProvider jwtTokenProvider;

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        String token = resolveToken((HttpServletRequest) servletRequest);
        if (token != null && jwtTokenProvider.validateToken(token)) {
            Authentication authentication = jwtTokenProvider.getAuthentication(token);
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        filterChain.doFilter(servletRequest, servletResponse);
    }

    // HttpServletRequest: ServletRequestë¥¼ ìƒì†í•˜ëŠ” í´ë˜ìŠ¤
    private String resolveToken(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");

        // StringUtils.hasText: Stringì´ ì‹¤ì§ˆì ìœ¼ë¡œ ë‚´ìš©ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer")) {
            return bearerToken.substring(7);
        }
        return null;
    }

}
```
ê¸°ì¡´ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.  
ë¨¼ì € ë¬´ìŠ¨ ìš”ì²­ì— ì˜í•´ í•„í„°ê°€ ì‘ë™í•˜ëŠ”ì§€ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•´ ë§¤ê°œë³€ìˆ˜ë¡œ ë“¤ì–´ì˜¤ëŠ” `servletRequest`ë¥¼ ëœ¯ì–´ë´¤ë‹¤.  
`System.out.println(((HttpServletRequest) servletRequest).getRequestURL());` ë¥¼ Filter ìµœìƒë‹¨ì— ì¶”ê°€í–ˆë‹¤.  
ì´í›„ ë‹¤ì‹œ ìš”ì²­ì„ ë³´ë‚´ë³´ì•˜ë‹¤. 

```
2025-04-25T10:17:50.769+09:00  INFO 5311 --- [backend] [nio-8080-exec-2] o.s.web.servlet.DispatcherServlet        : Completed initialization in 2 ms
http://localhost:8080/authtest
2025-04-25T10:17:50.772+09:00 ERROR 5311 --- [backend] [nio-8080-exec-2] d.f.d.b.security.jwt.JwtTokenProvider    : ìœ íš¨í•˜ì§€ ì•Šì€ JWT ì„œëª…
http://localhost:8080/error
2025-04-25T10:17:50.774+09:00 ERROR 5311 --- [backend] [nio-8080-exec-2] d.f.d.b.security.jwt.JwtTokenProvider    : ìœ íš¨í•˜ì§€ ì•Šì€ JWT ì„œëª…
```
ë¬´ì–¸ê°€ì— ì˜í•´ `/error` ë¡œ ë¼ìš°íŒ… ë˜ê³ ìˆë‹¤ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.  
`validateToken` ë©”ì„œë“œì˜ ë°˜í™˜ê²°ê³¼ê°€ `false`ë¼ì„œ `SecurityContextHolder`ì— ì¸ì¦ì •ë³´ë¥¼ ì„¤ì •í•˜ëŠ” ê³¼ì •ì´ ìƒëµëœë‹¤.  
ë‚´ë¶€ ì¸ì¦ê³¼ì •ì—ì„œ `/error` ë¡œ ë¼ìš°íŒ…í•˜ëŠ”ê²ƒ ê°™ì•„ ì¡°ê¸ˆ ë” ìì„¸í•œ ë¡œê·¸ë¥¼ ì°ì–´ë³´ì•˜ë‹¤.  
`application.properties`ì— `logging.level.org.springframework.security.web=DEBUG`ë¥¼ ì¶”ê°€í•˜ì—¬ ìì„¸í•œ ë¡œê·¸ë¥¼ í™•ì¸í–ˆë‹¤.  

```
2025-04-25T10:49:12.902+09:00 DEBUG 5311 --- [backend] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Securing POST /authtest
http://localhost:8080/authtest
2025-04-25T10:49:12.903+09:00 ERROR 5311 --- [backend] [nio-8080-exec-2] d.f.d.b.security.jwt.JwtTokenProvider    : ìœ íš¨í•˜ì§€ ì•Šì€ JWT ì„œëª…
2025-04-25T10:49:12.903+09:00 DEBUG 5311 --- [backend] [nio-8080-exec-2] o.s.s.w.a.AnonymousAuthenticationFilter  : Set SecurityContextHolder to anonymous SecurityContext
2025-04-25T10:49:12.903+09:00 DEBUG 5311 --- [backend] [nio-8080-exec-2] o.s.s.w.a.Http403ForbiddenEntryPoint     : Pre-authenticated entry point called. Rejecting access
2025-04-25T10:49:12.904+09:00 DEBUG 5311 --- [backend] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Securing POST /error
http://localhost:8080/error
2025-04-25T10:49:12.904+09:00 ERROR 5311 --- [backend] [nio-8080-exec-2] d.f.d.b.security.jwt.JwtTokenProvider    : ìœ íš¨í•˜ì§€ ì•Šì€ JWT ì„œëª…
2025-04-25T10:49:12.905+09:00 DEBUG 5311 --- [backend] [nio-8080-exec-2] o.s.s.w.a.AnonymousAuthenticationFilter  : Set SecurityContextHolder to anonymous SecurityContext
2025-04-25T10:49:12.905+09:00 DEBUG 5311 --- [backend] [nio-8080-exec-2] o.s.s.w.a.Http403ForbiddenEntryPoint     : Pre-authenticated entry point called. Rejecting access
```
Spring Securityê°€ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì˜ ì ‘ê·¼ì„ ê°ì§€í•˜ì—¬ `Http403ForbiddenEntryPoint`ë¥¼ í˜¸ì¶œí–ˆë‹¤.  
403 ìƒíƒœì½”ë“œê°€ ë°œìƒí–ˆê¸°ë•Œë¬¸ì— ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ í•´ë‹¹ ìƒíƒœì½”ë“œì— ëŒ€ì‘í•˜ëŠ” ì—ëŸ¬í˜ì´ì§€ë¥¼ ì°¾ê³  ë„˜ê¸´ê²ƒì´ë‹¤.

ì–´ì°Œëë“  í•œ ìš”ì²­ì— ëŒ€í•´ í•„í„°ê°€ ì—¬ëŸ¬ë²ˆ ì‘ë™í•œê²ƒì´ë‹ˆ, ìš”ì²­ì— ëŒ€í•´ í•œë²ˆë§Œ ì‹¤í–‰í•˜ê²Œ í•˜ë©´ ëœë‹¤.  
`GenericFilterBean` ëŒ€ì‹  `OncePerRequestFilter`ë¥¼ ìƒì†í•˜ì—¬ í•´ê²°í•œë‹¤.  
* `GenericFilterBean`
    * ëª¨ë“  ë””ìŠ¤íŒ¨ì²˜ íƒ€ì…ì˜ ì¬ìš”ì²­ ë§ˆë‹¤ `doFilter` ê°€ ì‹¤í–‰ëœë‹¤.
    * ë³„ë„ì˜ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì¥ì¹˜ê°€ ì—†ì–´ ìš”ì²­ì´ ë‹¤ì‹œ ë“¤ì–´ì˜¤ë©´ í•„í„°ê°€ ë‹¤ì‹œ ë™ì‘í•œë‹¤.
* `OncePerRequestFilter`
    * `doFilter` ì§„ì… ì‹œ ìš”ì²­ ê°ì²´ì— "í•„í„°ì´ë¦„ + FILTERED" ì ‘ë¯¸ì‚¬ë¡œ ëœ ì†ì„±ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
    * ì†ì„±ì´ ì—†ìœ¼ë©´ í•´ë‹¹ ì†ì„±ì„ ì„¤ì •í•œ ë’¤ `doFilterInternal`ì„ í˜¸ì¶œí•´ ë¡œì§ì„ ìˆ˜í–‰í•œë‹¤.
    * ì†ì„±ì´ ì´ë¯¸ ìˆìœ¼ë©´ ë‘ ë²ˆì§¸ ì´ìƒ í˜¸ì¶œì„ì„ ì¸ì§€í•˜ê³  ë°”ë¡œ ë‹¤ìŒ ì²´ì¸ìœ¼ë¡œ ìš”ì²­ì„ ë„˜ê¸´ë‹¤

ì¶”ê°€ë¡œ ì¸ì¦ë˜ì§€ ì•Šì€ ìš”ì²­ì— ëŒ€í•´ ì¼ê´€ëœ ì‘ë‹µì„ ë°˜í™˜í•˜ë©´ ì¢‹ì„ê²ƒê°™ë‹¤.  

## ğŸ€ Spring Security ë‚´ë¶€ì—ì„œ ë°œìƒí•˜ëŠ” ì¸ì¦ê´€ë ¨ ì˜ˆì™¸ ë‹¤ë£¨ê¸°
ìœ„ì—ì„œ ì¸ì¦ê´€ë ¨ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ë•Œ íŠ¹ì • `EntryPoint` ë¡œ ë“¤ì–´ê°€ëŠ”ê²ƒì„ í™•ì¸í–ˆì—ˆë‹¤.  
ì§ì ‘ `EntryPoint`ë¥¼ êµ¬í˜„í•˜ì—¬ Spring Securityì— ë“±ë¡í•´ë³´ì.  

```java
@Component
public class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint {

    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
        ErrorCode ec = AuthErrorCode.REQUIRE_AUTHENTICATION;
        ApiResponse<Void> apiResponse = ApiResponse.error(List.of(ec));
        response.setStatus(ec.getStatus().value());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        String json = objectMapper.writeValueAsString(apiResponse);
        response.getWriter().write(json);
    }

}
```
`AuthenticationEntryPoint` ë¥¼ ìƒì†í•˜ì—¬ êµ¬í˜„í•œë‹¤.  


## ğŸ€ JpaRepository ë°˜í™˜í˜• ì„ íƒ
* Spring Data JPAì˜ ë ˆí¬ì§€í† ë¦¬ ë©”ì„œë“œëŠ” ë°˜í™˜ íƒ€ì…ì— ë”°ë¼ ì¡°íšŒ ê²°ê³¼ ì²˜ë¦¬ ë°©ì‹ì´ ë‹¬ë¼ì§„ë‹¤.
* í¬ê²Œ ë„¤ê°€ì§€ ì¹´í…Œê³ ë¦¬ë¡œ êµ¬ë¶„í•´ ì„¤ê³„í•œë‹¤.

### ë‹¨ê±´ ì¡°íšŒ (Single Result)
`Optional<T>`  
ì¡°íšŒ ê²°ê³¼ê°€ ì—†ì„ ìˆ˜ë„ ìˆì„ ë•Œ ì‚¬ìš©.  
ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `Optional.empty()`ë¥¼ ë°˜í™˜í•´ NPEë¥¼ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.  

`T (Entity)`  
ê²°ê³¼ê°€ ë°˜ë“œì‹œ ì¡´ì¬í•¨ì´ ë³´ì¥ë  ë•Œ ì“´ë‹¤.  
ê²°ê³¼ê°€ ì—†ìœ¼ë©´ nullì´, 2ê±´ ì´ìƒì´ë©´ `IncorrectResultSizeDataAccessException`ì´ ë°œìƒí•œë‹¤.

`void`  
ì¡°íšŒê°€ ì•„ë‹Œ ìƒíƒœ ë³€ê²½ìš© ë©”ì„œë“œëŠ” `void`ë¥¼ ë°˜í™˜í•´ë„ ëœë‹¤.

### ë‹¤ê±´ ì¡°íšŒ (Collection Result)
`List<T>`  
ê°€ì¥ ì¼ë°˜ì ì¸ ë‹¤ê±´ ì¡°íšŒ íƒ€ì…, ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤.

`Set<T>`, `Collection<T>`  
ì¤‘ë³µì œê±°ë‚˜ íŠ¹ì • `Collection` ì¸í„°í˜ì´ìŠ¤ê°€ í•„ìš”í•  ë•Œ ì‚¬ìš©í•œë‹¤.

`Stream<T>`  
ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ ì‹œ ìŠ¤íŠ¸ë¦¼ APIë¡œ ì§€ì—° ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë‚˜, ì‚¬ìš© í›„ `close()`ë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜  
try-with-resourcesë¡œ ê°ì‹¸ì•¼ í•œë‹¤.

### í˜ì´ì§• ë° ìŠ¬ë¼ì´ìŠ¤ ì¡°íšŒ
`Page<T>`  
ì „ì²´ í˜ì´ì§€ ìˆ˜, í˜„ì¬ í˜ì´ì§€ ì •ë³´, ì½˜í…ì¸  ë¦¬ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ë°˜í™˜í•œë‹¤.

`Slice<T>`  
ë‹¤ìŒ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€ë§Œ ì•Œê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•´ ë¶ˆí•„ìš”í•œ ì „ì²´ ê±´ìˆ˜ ì¹´ìš´íŠ¸ë¥¼ ìƒëµí•  ìˆ˜ ìˆë‹¤.

(`Stream<T>` + `Pageable`), (`List<T>` + `Pageable`)  
ë³„ë„ ë©”ì„œë“œ ì˜¤ë²„ë¡œë“œë¡œ í˜ì´ì§€ ìš”ì²­ ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„  
ë‹¤ì–‘í•œ í˜ì´ì§•, ì •ë ¬ ì „ëµì„ ì§€ì›í•œë‹¤.

### ë¹„ë™ê¸° ë° ê¸°íƒ€ ë°˜í™˜ íƒ€ì…
`CompletableFuture<T>`, `ListenableFuture<T>`  
`@Async`ë¥¼ ë¶™ì—¬ ë¹„ë™ê¸° ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë¹„ë™ê¸° ì½œë°±, í•©ì„± APIë¡œ ë‹¤ë£° ìˆ˜ ìˆë‹¤.

`Optional<Collection<T>>`, `Future<T>` ë“±
ìŠ¤í† ì–´ íŠ¹ì„±ì— ë”°ë¼ ì§€ì›ë˜ëŠ” ë˜í¼ íƒ€ì…ì´ ë‹¤ì–‘í•˜ë‹¤. ê³µì‹ ë¬¸ì„œ ì°¸ê³  í•„ìš”.

### ì„ íƒ ê°€ì´ë“œ
* ê²€ìƒ‰ ê²°ê³¼ê°€ 0~1ê±´ : `Optional<T>`, ë¯¸ì¡´ì¬ ëŒ€ì‘ ë¡œì§ì´ ì—†ìœ¼ë©´ `T`
* ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ëŸ¬ ê±´ : `List<T>`, ì¤‘ë³µ ì œê±° ì‹œ `Set<T>`, í˜ì´ì§€ ë‹¨ìœ„ë¡œ ë°˜í™˜ ì‹œ `Page<T>` or `Slice<T>`
* ëŒ€ìš©ëŸ‰, ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ : `Stream<T>` + try-with-resources
* ë¹„ë™ê¸° í˜¸ì¶œ : `CompletableFuture<T>` + `@Async`